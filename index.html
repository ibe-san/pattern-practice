<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Pattern Practice ドリル</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--safe-top:env(safe-area-inset-top);--safe-bot:env(safe-area-inset-bottom)}
html,body{height:100%;height:100dvh;overflow:hidden;margin:0}
body{background:linear-gradient(145deg,#0a0a1a 0%,#111128 50%,#0d1b2a 100%);
  font-family:-apple-system,'Hiragino Sans','Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif;
  color:#fff;padding:0;overflow-x:hidden}
.mono{font-family:'SF Mono','Menlo','Consolas',monospace}
.screen{display:none;height:100dvh}
.screen.active{display:flex;flex-direction:column;overflow:hidden}

/* MENU */
.menu-screen{padding:calc(16px + var(--safe-top)) calc(16px + env(safe-area-inset-right)) calc(16px + var(--safe-bot)) calc(16px + env(safe-area-inset-left));overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1;min-height:0}
.menu-header{text-align:center;margin-bottom:18px}
.menu-logo{font-size:10px;letter-spacing:2px;color:rgba(255,255,255,0.25);text-transform:uppercase;margin-bottom:3px}
.menu-title{font-size:22px;font-weight:700;background:linear-gradient(135deg,#E07A5F,#F2CC8F);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.menu-sub{font-size:11px;color:rgba(255,255,255,0.3);margin-top:3px}
.menu-grid{display:grid;gap:10px;overflow:hidden}
.menu-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:14px 16px;cursor:pointer;transition:all 0.15s;overflow:hidden;min-width:0}
.menu-card:active{transform:scale(0.98);background:rgba(255,255,255,0.06)}
.mc-top{display:flex;align-items:baseline;gap:8px;margin-bottom:6px;min-width:0}
.mc-num{font-size:11px;font-weight:700;color:#E07A5F;min-width:34px}
.mc-title{flex:1;font-size:14px;font-weight:600;line-height:1.4;word-break:break-word}
.mc-count{font-size:10px;color:rgba(255,255,255,0.3)}
.mc-progress{height:3px;background:rgba(255,255,255,0.06);border-radius:2px;margin-bottom:5px}
.mc-progress-fill{height:100%;border-radius:2px;background:#52B788;transition:width 0.3s}
.mc-stats{display:flex;gap:10px;font-size:10px;color:rgba(255,255,255,0.3)}
.mc-stat-ok{color:rgba(82,183,136,0.7)}
.mc-stat-ng{color:rgba(239,71,111,0.7)}
.mc-sections{font-size:10px;color:rgba(255,255,255,0.2);margin-top:4px;line-height:1.5;word-break:break-word;overflow-wrap:break-word}
.shuffle-row{display:flex;align-items:center;justify-content:center;gap:8px;margin:14px 0 8px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor:pointer}
.shuffle-label{font-size:12px;color:rgba(255,255,255,0.4)}
.sw{width:36px;height:20px;border-radius:10px;background:rgba(255,255,255,0.1);position:relative;transition:background 0.2s}
.sw.on{background:rgba(224,122,95,0.5)}
.sw::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left 0.2s}
.sw.on::after{left:18px}

/* OVERLAYS */
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:100;align-items:center;justify-content:center;padding:20px}
.overlay.visible{display:flex}
.modal{background:#1a1a2e;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:18px;max-width:360px;width:100%;max-height:75vh;display:flex;flex-direction:column}

/* Section Select */
.sec-title{font-size:14px;font-weight:600;margin-bottom:4px}
.sec-sub{font-size:11px;color:rgba(255,255,255,0.35);margin-bottom:10px}
.sec-list{overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding:2px;-webkit-overflow-scrolling:touch}
.sec-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);cursor:pointer;transition:all 0.15s}
.sec-item:active{background:rgba(255,255,255,0.08)}
.sec-item.selected{border-color:rgba(224,122,95,0.5);background:rgba(224,122,95,0.1)}
.sec-cb{width:18px;height:18px;border-radius:4px;border:1.5px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sec-item.selected .sec-cb{border-color:#E07A5F;background:#E07A5F}
.sec-item.selected .sec-cb::after{content:'\2713';font-size:12px;color:#fff}
.sec-name{flex:1;font-size:13px}
.sec-cnt{font-size:10px;color:rgba(255,255,255,0.3)}
.sec-actions{display:flex;gap:8px;margin-top:12px}
.sec-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer}
.sec-btn.cancel{background:transparent;color:rgba(255,255,255,0.4);border:1px solid rgba(255,255,255,0.1)}
.sec-btn.ok{background:#E07A5F;color:#fff}
.sec-btn:disabled{opacity:0.3}
.sec-all{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.5);font-size:11px;cursor:pointer;margin-bottom:8px}

/* Mode Select */
.mode-title{font-size:14px;font-weight:600;margin-bottom:14px;text-align:center}
.mode-btn{width:100%;padding:12px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:8px;text-align:left;display:flex;align-items:center;gap:10px}
.mode-btn .icon{font-size:16px;width:24px;text-align:center}
.mode-btn .info{flex:1}
.mode-btn .info-sub{font-size:10px;opacity:0.6;margin-top:2px}
.mode-btn.start{background:rgba(224,122,95,0.15);color:#E07A5F;border:1px solid rgba(224,122,95,0.3)}
.mode-btn.resume{background:rgba(242,204,143,0.12);color:#F2CC8F;border:1px solid rgba(242,204,143,0.3)}
.mode-btn.retry{background:rgba(239,71,111,0.12);color:#EF476F;border:1px solid rgba(239,71,111,0.3)}
.mode-btn.reset{background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.4);border:1px solid rgba(255,255,255,0.08);margin-top:4px}
.mode-btn.mcancel{background:transparent;color:rgba(255,255,255,0.35);border:1px solid rgba(255,255,255,0.08)}
.mode-btn:disabled{opacity:0.25;pointer-events:none}

/* PRACTICE */
.practice-screen{max-width:480px;margin:0 auto;width:100%;flex:1;min-height:0;display:flex;flex-direction:column;padding-top:var(--safe-top);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}
.header{padding:10px 16px 6px;display:flex;align-items:center;gap:8px}
.header-back{background:none;border:none;color:rgba(255,255,255,0.4);font-size:18px;cursor:pointer;padding:4px}
.header-title{flex:1;font-size:13px;font-weight:600;color:rgba(255,255,255,0.7)}
.header-title b{color:#E07A5F}
.counter{font-size:12px;color:rgba(255,255,255,0.35);padding:3px 8px;border-radius:6px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);cursor:pointer}
.progress-bar{margin:0 16px 6px;height:3px;background:rgba(255,255,255,0.06);border-radius:2px}
.progress-fill{height:100%;background:#E07A5F;border-radius:2px;transition:width 0.3s}
.section-badge{text-align:center;margin:0 16px 4px;font-size:10px;color:rgba(255,255,255,0.25)}

.card-area{flex:1;display:flex;flex-direction:column;padding:0 16px;min-height:0;overflow:hidden}
.card{flex:1;display:flex;flex-direction:column;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:18px;overflow:hidden}
.q-section{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 22px;border-bottom:1px solid rgba(255,255,255,0.06);position:relative}
.q-label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;color:#E07A5F;margin-bottom:10px}
.q-text{font-size:24px;font-weight:600;line-height:1.55;text-align:center;color:#fff}
.q-text.small{font-size:19px}
.speak-btn{display:inline-flex;align-items:center;gap:4px;margin-top:10px;padding:4px 12px;border-radius:100px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.5);font-size:10px;cursor:pointer}
.speak-btn:active{background:rgba(255,255,255,0.12)}
.a-section{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px 22px;position:relative;cursor:pointer}
.a-label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;font-weight:600;color:#F2CC8F;margin-bottom:10px}
.a-text{font-size:24px;font-weight:600;line-height:1.55;text-align:center;color:#fff}
.a-text.small{font-size:18px}
.a-section.hidden-answer{cursor:pointer}
.a-section.hidden-answer .a-label,.a-section.hidden-answer .a-text,.a-section.hidden-answer .speak-btn{visibility:hidden}
.a-section.hidden-answer::after{content:'\30BF\30C3\30D7\3067\56DE\7B54\3092\8868\793A';position:absolute;font-size:12px;color:rgba(255,255,255,0.2)}
.a-section.revealed .a-label,.a-section.revealed .a-text,.a-section.revealed .speak-btn{visibility:visible;animation:fadeUp 0.3s ease-out}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.history-mark{position:absolute;top:8px;right:12px;font-size:10px;padding:1px 6px}
.history-mark.ok{color:rgba(82,183,136,0.5)}
.history-mark.ng{color:rgba(239,71,111,0.5)}

.controls{padding:8px 16px calc(12px + var(--safe-bot));display:flex;flex-direction:column;gap:8px}
.nav-row{display:flex;align-items:center;justify-content:center;gap:14px}
.nav-btn{width:44px;height:44px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s}
.nav-btn:active{background:rgba(255,255,255,0.1);transform:scale(0.92)}
.nav-btn:disabled{opacity:0.2;pointer-events:none}
.nav-btn svg{width:18px;height:18px}
.judge-btn{width:50px;height:50px;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;font-size:18px;font-weight:700;transition:all 0.15s}
.judge-btn:active{transform:scale(1.12)}
.judge-btn.wrong{border-color:rgba(239,71,111,0.4);color:#EF476F}
.judge-btn.correct{border-color:rgba(82,183,136,0.4);color:#52B788}
.judge-btn:disabled{opacity:0.2;pointer-events:none}
.score-row{display:flex;justify-content:center;gap:20px}
.score-item{display:flex;align-items:center;gap:4px}
.score-dot{width:6px;height:6px;border-radius:50%}
.score-num{font-size:11px;color:rgba(255,255,255,0.4)}

@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideInR{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}
.card.anim-next{animation:slideIn 0.22s ease-out}
.card.anim-prev{animation:slideInR 0.22s ease-out}

/* Jump */
.jump-modal{max-width:340px}
.jump-title{font-size:13px;font-weight:600;margin-bottom:12px;color:rgba(255,255,255,0.7)}
.jump-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;overflow-y:auto;padding:2px;-webkit-overflow-scrolling:touch}
.jump-cell{height:40px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.jump-cell.active{background:rgba(224,122,95,0.2);border-color:rgba(224,122,95,0.5);color:#E07A5F}
.jump-cell.done{background:rgba(82,183,136,0.12);border-color:rgba(82,183,136,0.3);color:#52B788}
.jump-cell.has-wrong{background:rgba(239,71,111,0.12);border-color:rgba(239,71,111,0.3);color:#EF476F}
.jump-close{margin-top:12px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer;width:100%}

/* Result */
.result-overlay{z-index:50;background:rgba(10,10,26,0.95)}
.result-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:32px 24px;text-align:center;max-width:360px;width:100%}
.result-pct{font-size:42px;font-weight:700;color:#E07A5F;margin-bottom:2px}
.result-sub{font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:24px}
.result-stats{display:flex;gap:16px;justify-content:center;margin-bottom:24px}
.result-stat-num{font-size:20px;font-weight:700}
.result-stat-label{font-size:9px;color:rgba(255,255,255,0.35);margin-top:2px}
.result-divider{width:1px;background:rgba(255,255,255,0.1)}
.rbtn{width:100%;padding:11px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;margin-top:6px}
.rbtn.primary{background:#E07A5F;color:#fff}
.rbtn.retry{background:rgba(239,71,111,0.12);color:#EF476F;border:1px solid rgba(239,71,111,0.3)}
.rbtn.secondary{background:transparent;color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.1)}

/* Auto Play Settings */
.auto-row-menu{display:flex;align-items:center;justify-content:center;gap:8px;margin:0 0 4px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor:pointer}
.auto-label-menu{font-size:12px;color:rgba(255,255,255,0.4)}
.auto-settings{display:none;margin:0 0 4px}
.auto-settings.visible{display:block}
.auto-time-row{display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);margin-bottom:4px}
.auto-time-label{font-size:11px;color:rgba(255,255,255,0.35);flex:1;text-align:left}
.auto-time-val{display:flex;align-items:center;gap:6px}
.auto-time-val button{width:28px;height:28px;border-radius:50%;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.5);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.auto-time-val button:active{background:rgba(255,255,255,0.15)}
.auto-time-val span.sec-display{font-size:13px;color:#F2CC8F;width:20px;text-align:center;font-weight:600}
.auto-time-val span.sec-unit{font-size:10px;color:rgba(255,255,255,0.2)}

/* Auto Play Bar */
.auto-bar{display:none;align-items:center;justify-content:center;gap:14px;padding:8px 16px}
.auto-bar.visible{display:flex}
.timer-ring{position:relative;width:38px;height:38px}
.timer-ring svg{transform:rotate(-90deg)}
.timer-ring text{transform:rotate(90deg);transform-origin:center}
.auto-pause-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:100px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);cursor:pointer;color:rgba(255,255,255,0.5);font-size:11px}
.auto-pause-btn:active{background:rgba(255,255,255,0.12)}
.auto-status{font-size:11px;color:rgba(255,255,255,0.3)}

/* Confirm */
.confirm-text{font-size:13px;color:rgba(255,255,255,0.7);margin-bottom:16px;text-align:center;line-height:1.6}
.confirm-actions{display:flex;gap:8px}
.confirm-btn{flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer}
.confirm-btn.yes{background:rgba(239,71,111,0.2);color:#EF476F;border:1px solid rgba(239,71,111,0.3)}
.confirm-btn.no{background:transparent;color:rgba(255,255,255,0.4);border:1px solid rgba(255,255,255,0.1)}
</style>
</head>
<body>

<!-- MENU -->
<div class="screen active" id="scr-menu">
<div class="menu-screen">
  <div class="menu-header">
    <div class="menu-logo">Pattern Practice</div>
    <div class="menu-title">ドリル</div>
    <div class="menu-sub" id="menu-sub"></div>
  </div>
  <div class="menu-grid" id="menu-grid"></div>
  <div class="auto-row-menu" onclick="toggleAutoMode()">
    <span class="auto-label-menu">Auto Play</span>
    <div class="sw" id="sw-auto"></div>
  </div>
  <div class="auto-settings" id="auto-settings">
    <div class="auto-time-row">
      <div class="auto-time-label">表面の表示時間</div>
      <div class="auto-time-val"><button onclick="event.stopPropagation();adjTime('front',-1)">−</button><span class="sec-display" id="auto-front-sec">3</span><button onclick="event.stopPropagation();adjTime('front',1)">+</button><span class="sec-unit">秒</span></div>
    </div>
    <div class="auto-time-row">
      <div class="auto-time-label">裏面の表示時間</div>
      <div class="auto-time-val"><button onclick="event.stopPropagation();adjTime('back',-1)">−</button><span class="sec-display" id="auto-back-sec">3</span><button onclick="event.stopPropagation();adjTime('back',1)">+</button><span class="sec-unit">秒</span></div>
    </div>
  </div>
  <div class="shuffle-row" onclick="toggleShuffle()">
    <span class="shuffle-label">シャッフル</span>
    <div class="sw" id="sw-shuffle"></div>
  </div>
</div>
</div>

<!-- SECTION SELECT -->
<div class="overlay" id="ov-sec" onclick="if(event.target===this)closeSec()">
<div class="modal">
  <div class="sec-title" id="sec-title"></div>
  <div class="sec-sub" id="sec-sub"></div>
  <button class="sec-all" onclick="toggleAllSec()">すべて選択 / 解除</button>
  <div class="sec-list" id="sec-list"></div>
  <div class="sec-actions">
    <button class="sec-btn cancel" onclick="closeSec()">キャンセル</button>
    <button class="sec-btn ok" id="sec-ok" onclick="confirmSec()">次へ</button>
  </div>
</div>
</div>

<!-- MODE SELECT -->
<div class="overlay" id="ov-mode" onclick="if(event.target===this)closeMode()">
<div class="modal" style="max-width:320px">
  <div class="mode-title" id="mode-title"></div>
  <div id="mode-body"></div>
</div>
</div>

<!-- CONFIRM -->
<div class="overlay" id="ov-confirm" onclick="if(event.target===this)closeConfirm()">
<div class="modal" style="max-width:300px;padding:24px">
  <div class="confirm-text" id="confirm-text"></div>
  <div class="confirm-actions">
    <button class="confirm-btn no" onclick="closeConfirm()">キャンセル</button>
    <button class="confirm-btn yes" id="confirm-yes">リセット</button>
  </div>
</div>
</div>

<!-- PRACTICE -->
<div class="screen" id="scr-practice">
<div class="practice-screen">
  <div class="header">
    <button class="header-back" onclick="backToMenu()">◀</button>
    <div class="header-title" id="hdr-title"></div>
    <div class="counter mono" id="counter" onclick="openJump()"></div>
  </div>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  <div class="section-badge" id="section-badge"></div>
  <div class="card-area">
    <div class="card" id="card">
      <div class="q-section">
        <div class="q-label">日本語</div>
        <div class="q-text" id="q-text"></div>
        <button class="speak-btn" onclick="speakJa()">▶ 読み上げ</button>
        <div class="history-mark" id="q-hist"></div>
      </div>
      <div class="a-section hidden-answer" id="a-section" onclick="revealAnswer()">
        <div class="a-label">ENGLISH</div>
        <div class="a-text" id="a-text"></div>
        <button class="speak-btn" onclick="event.stopPropagation();speakEn()">▶ Speak</button>
      </div>
    </div>
  </div>
  <div class="auto-bar" id="auto-bar">
    <div class="timer-ring">
      <svg width="38" height="38" viewBox="0 0 38 38">
        <circle cx="19" cy="19" r="17" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="2.5"/>
        <circle cx="19" cy="19" r="17" fill="none" stroke="#E07A5F" stroke-width="2.5" stroke-linecap="round" id="ring-fg" stroke-dasharray="106.81" stroke-dashoffset="0"/>
        <text x="19" y="19" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="11" font-weight="600" id="timer-text">3</text>
      </svg>
    </div>
    <button class="auto-pause-btn" onclick="toggleAutoPause()">
      <span id="pause-icon">⏸</span><span id="play-icon" style="display:none">▶</span>
      <span id="pause-label">一時停止</span>
    </button>
    <span class="auto-status" id="auto-status">Auto Play 再生中...</span>
  </div>
  <div class="controls" id="manual-controls">
    <div class="nav-row">
      <button class="nav-btn" id="btn-prev" onclick="goPrev()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
      <button class="judge-btn wrong" id="btn-wrong" onclick="judge(false)">✕</button>
      <button class="judge-btn correct" id="btn-ok" onclick="judge(true)">◯</button>
      <button class="nav-btn" id="btn-next" onclick="goNext()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
    </div>
    <div class="score-row">
      <div class="score-item"><div class="score-dot" style="background:#52B788"></div><span class="score-num mono" id="s-ok">0</span></div>
      <div class="score-item"><div class="score-dot" style="background:#EF476F"></div><span class="score-num mono" id="s-ng">0</span></div>
    </div>
  </div>
</div>
</div>

<!-- JUMP -->
<div class="overlay" id="ov-jump" onclick="if(event.target===this)closeJump()">
<div class="modal jump-modal">
  <div class="jump-title">問題にジャンプ</div>
  <div class="jump-grid" id="jump-grid"></div>
  <button class="jump-close" onclick="closeJump()">閉じる</button>
</div>
</div>

<!-- RESULT -->
<div class="overlay result-overlay" id="ov-result">
<div class="result-card">
  <div class="result-pct mono" id="r-pct"></div>
  <div class="result-sub" id="r-sub"></div>
  <div class="result-stats">
    <div><div class="result-stat-num" style="color:#52B788" id="r-ok">0</div><div class="result-stat-label">Correct</div></div>
    <div class="result-divider"></div>
    <div><div class="result-stat-num" style="color:#EF476F" id="r-ng">0</div><div class="result-stat-label">Wrong</div></div>
  </div>
  <button class="rbtn primary" onclick="restartFromResult()">もう一度</button>
  <button class="rbtn retry" id="r-retry" onclick="retryWrongFromResult()">❌ だけ再チャレンジ (<span id="r-retry-n">0</span>問)</button>
  <button class="rbtn secondary" style="margin-top:8px" onclick="backToMenu()">メニューに戻る</button>
</div>
</div>

<script>
// ===== DATA =====
var DB=[{"id": "Ex.2", "sections": [{"title": "to不定詞（形容詞的用法）", "items": [{"ja": "読むための本", "en": "a book to read"}, {"ja": "行く場所", "en": "a place to go"}, {"ja": "売るための絵", "en": "a picture to sell"}, {"ja": "住む家", "en": "a house to live"}, {"ja": "伝えるべき話", "en": "a story to tell"}, {"ja": "修理すべきパソコン", "en": "a computer to repair"}, {"ja": "メモをとるためのペン", "en": "a pen to take notes"}, {"ja": "掃除すべき机", "en": "a desk to clean"}, {"ja": "贈るプレゼント", "en": "a present to give"}, {"ja": "泊まる部屋", "en": "a room to stay"}, {"ja": "書くべき手紙", "en": "a letter to write"}, {"ja": "運転する車", "en": "a car to drive"}, {"ja": "会うべき人", "en": "a person (someone) to meet"}, {"ja": "ピクニックを楽しめる公園", "en": "a park to enjoy a picnic"}, {"ja": "解くべき問題", "en": "a problem to solve"}, {"ja": "買うべきチケット", "en": "a ticket to buy"}, {"ja": "撮るべき写真", "en": "a picture to take"}, {"ja": "尋ねるべき質問", "en": "a question to ask"}, {"ja": "飾る部屋", "en": "a room to decorate"}, {"ja": "送るべきメッセージ", "en": "a message to send"}, {"ja": "見るべきショー", "en": "a show to watch"}, {"ja": "勝つべき試合", "en": "a game to win"}, {"ja": "行うべきスピーチ", "en": "a speech to give"}, {"ja": "達成すべき目標", "en": "a goal to achieve"}, {"ja": "下すべき決定", "en": "a decision to make"}, {"ja": "参加すべきチーム", "en": "a team to join"}, {"ja": "議論すべき問題", "en": "a problem to discuss"}, {"ja": "直面すべき課題", "en": "a challenge to face"}, {"ja": "共有する話", "en": "a story to share"}, {"ja": "従うべきルール", "en": "a rule to follow"}, {"ja": "向上させるべきスキル", "en": "a skill to improve"}, {"ja": "完成させるべきプロジェクト", "en": "a project to complete"}]}], "total": 32}, {"id": "Ex.3", "sections": [{"title": "to不定詞（副詞的用法）", "items": [{"ja": "彼女は一生懸命勉強する＋試験に合格するために。", "en": "She studies hard to pass the exam."}, {"ja": "彼は早く出発した＋電車に間に合うように。", "en": "He left early to catch the train."}, {"ja": "彼らは一緒に働いた＋プロジェクトを完成させるために。", "en": "They worked together to complete the project."}, {"ja": "私は店に行った＋牛乳を買うために。", "en": "I went to the store to buy some milk."}, {"ja": "彼女は速く走った＋レースに勝つために。", "en": "She ran fast to win the race."}, {"ja": "彼らは都市に引っ越した＋新しい生活を始めるために。", "en": "They moved to the city to start a new life."}, {"ja": "私たちは会議を開いた＋その問題を議論するために。", "en": "We had a meeting to discuss the problem."}, {"ja": "彼は一生懸命働いた＋お金を貯めるために。", "en": "He worked hard to save money."}, {"ja": "彼女は図書館へ行った＋本を借りるために。", "en": "She went to the library to borrow a book."}, {"ja": "私はクラブに入会した＋知識を深めるために。", "en": "I joined the club to deepen my knowledge."}, {"ja": "私はあなたにしてほしい＋その本を読むことを。", "en": "I want you to read the book."}, {"ja": "彼はMaryに頼んだ＋ピアノを弾くように。", "en": "He asked Mary to play the piano."}, {"ja": "母は私たちに言った＋静かにするように。", "en": "Our mother told us to be quiet."}, {"ja": "彼女は悲しかった＋さようならを言うのが。", "en": "She was sad to say goodbye."}, {"ja": "私は興奮した＋チームに参加して。", "en": "I was excited to join the team."}, {"ja": "彼は驚いた＋その結果を見て。", "en": "He was surprised to see the result."}, {"ja": "すみません＋お邪魔して。", "en": "I'm sorry to interrupt you."}, {"ja": "彼は成長した＋そして有名な歌手になった。", "en": "He grew up to become a famous singer."}, {"ja": "彼は幸運だった＋チケットを手に入れて。", "en": "He was lucky to get a ticket."}, {"ja": "私たちは嬉しかった＋イベントに参加して。", "en": "We were glad to join the event."}, {"ja": "彼女は誇りに思った＋その賞を受賞して。", "en": "She was proud to win the prize."}, {"ja": "この箱は重すぎる＋運ぶには。", "en": "This box is too heavy to carry."}, {"ja": "彼女は若すぎる＋運転するには。", "en": "She is too young to drive."}, {"ja": "遅すぎる＋今出かけるには。", "en": "It's too late to go out now."}, {"ja": "そのケーキは甘すぎる＋食べるには。", "en": "The cake is too sweet to eat."}, {"ja": "彼女は充分上手く歌う＋オーディションに合格するほど。", "en": "She sings well enough to pass auditions."}, {"ja": "彼は充分賢い＋試験に合格するのに。", "en": "He is smart enough to pass the exam."}]}], "total": 27}, {"id": "Ex.4", "sections": [{"title": "関係代名詞（主格）", "items": [{"ja": "あなたの隣に座っている女の子", "en": "the girl who sits next to you"}, {"ja": "私を助けてくれる先生", "en": "the teacher who helps me"}, {"ja": "その質問に答える生徒", "en": "the student who answers the question"}, {"ja": "その店で働いている男性", "en": "the man who works at the store"}, {"ja": "テーブルの上にある本", "en": "the book that is on the table"}, {"ja": "赤いシャツを着ている男の子", "en": "the boy who is wearing a red shirt"}, {"ja": "外で遊んでいる子供", "en": "the child who is playing outside"}, {"ja": "路上で止まった車", "en": "the car that stopped on the street"}, {"ja": "通りの向こうに住んでいる女性", "en": "the woman who lives across the street"}, {"ja": "ギターを弾く男の子", "en": "the boy who plays the guitar"}, {"ja": "あなたに電話をかけた人", "en": "the person who called you"}, {"ja": "私をパーティーに招待した友人", "en": "the friend who invited me to the party"}, {"ja": "眼鏡をかけている女の子", "en": "the girl who is wearing glasses"}, {"ja": "英語を教える先生", "en": "the teacher who teaches English"}, {"ja": "そのレースで優勝した人", "en": "the person who won the race"}, {"ja": "私の家に住んでいる猫", "en": "the cat that lives in my house"}, {"ja": "ピアノを上手に弾ける男の子", "en": "the boy who plays the piano well"}, {"ja": "病院で働いている女性", "en": "the woman who works at the hospital"}, {"ja": "図書館で勉強している男の子", "en": "the boy who is studying in the library"}, {"ja": "パーティーに来た人たち", "en": "the people who came to the party"}, {"ja": "公園で走っている犬", "en": "the dog that is running in the park"}, {"ja": "ステージで歌っている歌手", "en": "the singer who is singing on stage"}, {"ja": "そのコンテストで優勝した女の子", "en": "the girl who won the contest"}, {"ja": "そのコンペで優勝した男の子", "en": "the boy who won the competition"}, {"ja": "この絵を描いたアーティスト", "en": "the artist who painted this picture"}, {"ja": "その賞を受賞した映画", "en": "the movie that won the award"}, {"ja": "その試合で勝ったチーム", "en": "the team that won the game"}, {"ja": "この製品を開発した会社", "en": "the company that developed this product"}, {"ja": "この方法を発見した科学者", "en": "the scientist who discovered this method"}, {"ja": "サッカーをする男の子", "en": "the boy who plays soccer"}, {"ja": "そのパン屋で働いている男性", "en": "the man who works at the bakery"}, {"ja": "昨日私を訪ねてきた人", "en": "the person who visited me yesterday"}]}], "total": 32}, {"id": "Ex.5", "sections": [{"title": "関係代名詞（目的格）", "items": [{"ja": "私が昨日読んだ本", "en": "the book which I read yesterday"}, {"ja": "私が公園で見た犬", "en": "the dog which I saw in the park"}, {"ja": "昨晩私たちが見た映画", "en": "the movie which we watched last night"}, {"ja": "昨日私が電話した人", "en": "the person who I called yesterday"}, {"ja": "コンサートで彼女が歌った歌", "en": "the song which she sang at the concert"}, {"ja": "私が先週買った椅子", "en": "the chair which I bought last week"}, {"ja": "私が昨日失くしたペン", "en": "the pen that I lost yesterday"}, {"ja": "彼が運転する車", "en": "the car which he drives"}, {"ja": "彼女がくれたプレゼント", "en": "the present which she gave me"}, {"ja": "あなたが招待した人", "en": "the person who you invited"}, {"ja": "彼らが勧めた映画", "en": "the movie which they recommended"}, {"ja": "今朝私が受け取った手紙", "en": "the letter which I received this morning"}, {"ja": "彼女が描いた絵", "en": "the picture which she painted"}, {"ja": "私があなたに買ったプレゼント", "en": "the present which I bought for you"}, {"ja": "私たちが昨夏訪れた街", "en": "the city which we visited last summer"}, {"ja": "私がした質問", "en": "the question which I asked"}, {"ja": "あなたが今読んでいる本", "en": "the book which you are reading now"}, {"ja": "彼が解決した問題", "en": "the problem which he solved"}, {"ja": "先週末私が見た映画", "en": "the movie which I watched last weekend"}, {"ja": "昨晩私が終わらせた宿題", "en": "the homework that I finished last night"}, {"ja": "私が尊敬する先生", "en": "the teacher who I respect"}, {"ja": "私たちがラジオで聞いた歌", "en": "the song which we heard on the radio"}, {"ja": "彼が監督した映画", "en": "the movie which he directed"}, {"ja": "彼女が話していた人", "en": "the person who she was talking to"}, {"ja": "彼がパーティーで撮った写真", "en": "the picture which he took at the party"}, {"ja": "私たちが昨夏行った場所", "en": "the place which we went to last summer"}, {"ja": "図書館で見かけた学生", "en": "the student who I saw at the library"}, {"ja": "公園で会った友達", "en": "the friend who I met at the park"}, {"ja": "あなたが私にくれた答え", "en": "the answer which you gave me"}, {"ja": "彼が私たちに話してくれた話", "en": "the story which he told us"}, {"ja": "彼女がその店で買ったバッグ", "en": "the bag that she bought at the store"}, {"ja": "私が昨日欠席したクラス", "en": "the class which I missed yesterday"}]}], "total": 32}, {"id": "Ex.6", "sections": [{"title": "関係副詞（where）", "items": [{"ja": "私がその本を買った店", "en": "the store where I bought the book"}, {"ja": "彼女が働いている都市", "en": "the city where she works"}, {"ja": "彼が育った家", "en": "the house where he grew up"}, {"ja": "彼らが会う場所", "en": "the place where they meet"}, {"ja": "私たちが滞在した島", "en": "the island where we stayed"}, {"ja": "彼女が教えている学校", "en": "the school where she teaches"}, {"ja": "私が勉強する図書館", "en": "the library where I study"}, {"ja": "私が生まれた国", "en": "the country where I was born"}, {"ja": "私たちがよく会うカフェ", "en": "the café where we often meet"}, {"ja": "彼が住んでいる通り", "en": "the street where he lives"}]}, {"title": "関係副詞（when）", "items": [{"ja": "彼がミスをした瞬間", "en": "the moment when he made a mistake"}, {"ja": "電車が到着する時間", "en": "the time when the train arrives"}, {"ja": "私たちが京都を訪れた夏", "en": "the summer when we visited Kyoto"}, {"ja": "彼女が去った日", "en": "the day when she left"}, {"ja": "彼らがこの橋を建てた年", "en": "the year when they built this bridge"}, {"ja": "彼がレースに勝った瞬間", "en": "the moment when he won the race"}, {"ja": "あなたが試験を受けた日", "en": "the day when you took the test"}, {"ja": "私たちが花火を見た夜", "en": "the night when we saw the fireworks"}, {"ja": "雪がたくさん降った冬", "en": "the winter when it snowed a lot"}]}, {"title": "関係副詞（why）", "items": [{"ja": "彼女が泣いている理由", "en": "the reason why she is crying"}, {"ja": "私が家にいた理由", "en": "the reason why I was at home"}, {"ja": "私が遅れた理由", "en": "the reason why I was late"}, {"ja": "私たちが英語を勉強する理由", "en": "the reason why we study English"}, {"ja": "私がこの歌を好きな理由", "en": "the reason why I like this song"}, {"ja": "彼らが引っ越した理由", "en": "the reason why they moved"}, {"ja": "彼が仕事を辞めた理由", "en": "the reason why he quit his job"}, {"ja": "私たちがもっと時間を必要とする理由", "en": "the reason why we need more time"}, {"ja": "彼らが笑った理由", "en": "the reason why they laughed"}]}, {"title": "関係副詞（how）", "items": [{"ja": "このようにして私たちは問題を解決した。", "en": "This is how we solved the problem."}, {"ja": "このようにして彼らはその家を建てた。", "en": "This is how they built the house."}, {"ja": "そのようにして彼女はケーキを作る。", "en": "That's how she makes a cake."}, {"ja": "そのようにして彼らはその試合に勝った。", "en": "That's how they won the game."}]}], "total": 32}, {"id": "Ex.7", "sections": [{"title": "現在分詞（-ing）", "items": [{"ja": "公園で遊んでいる子供", "en": "a child playing in the park"}, {"ja": "部屋で寝ている犬", "en": "a dog sleeping in the room"}, {"ja": "海で泳いでいる女性", "en": "a woman swimming in the sea"}, {"ja": "自転車に乗っている男の子", "en": "a boy riding a bike"}, {"ja": "外で走っている少年", "en": "a boy running outside"}, {"ja": "花を見ている女の子", "en": "a girl looking at flowers"}, {"ja": "電車を待っている人々", "en": "people waiting for a train"}, {"ja": "ピアノを弾いている学生", "en": "a student playing the piano"}, {"ja": "教室で勉強している生徒", "en": "a student studying in the classroom"}, {"ja": "友達と話している少女", "en": "a girl talking with her friend"}, {"ja": "音楽を聞いている少年", "en": "a boy listening to music"}, {"ja": "手紙を書いている女性", "en": "a woman writing a letter"}, {"ja": "部屋を掃除している男の子", "en": "a boy cleaning the room"}, {"ja": "車を運転している男性", "en": "a man driving a car"}, {"ja": "ケーキを作っている母親", "en": "a mother making a cake"}, {"ja": "公園でサッカーをしている少年たち", "en": "boys playing soccer in the park"}, {"ja": "机で本を読んでいる生徒", "en": "a student reading a book at the desk"}, {"ja": "公園で話している女の子たち", "en": "girls talking in the park"}, {"ja": "田舎に住んでいる家族", "en": "a family living in the countryside"}, {"ja": "台所で料理をしている女性", "en": "a woman cooking in the kitchen"}, {"ja": "笑っている赤ちゃん", "en": "a baby laughing"}, {"ja": "海で遊んでいる人々", "en": "people playing in the sea"}, {"ja": "砂浜で遊んでいる子供たち", "en": "children playing on the beach"}, {"ja": "ベンチに座っている年配者", "en": "an elderly man sitting on a bench"}, {"ja": "ピクニックを楽しんでいる人々", "en": "people enjoying a picnic"}, {"ja": "木の下で本を読んでいる少女", "en": "a girl reading a book under the tree"}, {"ja": "工場で働いている男性", "en": "a man working at the factory"}, {"ja": "モールで買い物をしている女性", "en": "a woman shopping at the mall"}, {"ja": "数学を教えている先生", "en": "a teacher teaching math"}, {"ja": "ネズミを追いかけている猫", "en": "a cat chasing a mouse"}, {"ja": "駅に近づいている電車", "en": "a train approaching the station"}, {"ja": "美しく咲いている花", "en": "a flower blooming beautifully"}]}], "total": 32}, {"id": "Ex.8", "sections": [{"title": "過去分詞（-ed）", "items": [{"ja": "英語で書かれた手紙", "en": "a letter written in English"}, {"ja": "公園で撮られた写真", "en": "a picture taken in the park"}, {"ja": "ドアに書かれた名前", "en": "a name written on the door"}, {"ja": "両親からもらったプレゼント", "en": "a present given by my parents"}, {"ja": "学校で使われる教科書", "en": "a textbook used at school"}, {"ja": "昨日見つかった鍵", "en": "a key found yesterday"}, {"ja": "多くの国で話されている言語", "en": "a language spoken in many countries"}, {"ja": "動物園で見られる動物", "en": "an animal seen at the zoo"}, {"ja": "昨年出版された本", "en": "a book published last year"}, {"ja": "チームによって解決された問題", "en": "a problem solved by the team"}, {"ja": "お母さんが焼いたケーキ", "en": "a cake baked by my mother"}, {"ja": "日曜日に開かれたイベント", "en": "an event held on Sunday"}, {"ja": "海外で生まれた赤ちゃん", "en": "a baby born overseas"}, {"ja": "公園に置き忘れられたカバン", "en": "a bag left in the park"}, {"ja": "昨晩見られた星", "en": "a star seen last night"}, {"ja": "その女性によって作られたドレス", "en": "a dress made by the woman"}, {"ja": "春に植えられた花", "en": "a flower planted in spring"}, {"ja": "映画で使われた曲", "en": "a song used in the movie"}, {"ja": "父から与えられたアドバイス", "en": "advice given by my father"}, {"ja": "19世紀に建てられた橋", "en": "a bridge built in the 19th century"}, {"ja": "市場で買われた果物", "en": "fruit bought at the market"}, {"ja": "湖で見つかったボート", "en": "a boat found in the lake"}, {"ja": "友人に送られた手紙", "en": "a letter sent to a friend"}, {"ja": "地震で被害を受けた建物", "en": "a building damaged by the earthquake"}, {"ja": "彼女の友人によって書かれた手紙", "en": "a letter written by her friend"}, {"ja": "家の前に駐車された車", "en": "a car parked in front of the house"}, {"ja": "ベートーベンによって作曲された歌", "en": "a song composed by Beethoven"}, {"ja": "内側から鍵がかけられたドア", "en": "a door locked from the inside"}, {"ja": "川の上に建設された橋", "en": "a bridge constructed over the river"}, {"ja": "彼女の母親によって焼かれたケーキ", "en": "a cake baked by her mother"}, {"ja": "テーブルの上に置かれた電話", "en": "a phone put on the table"}, {"ja": "ラジオで聞こえた歌", "en": "a song heard on the radio"}]}], "total": 32}, {"id": "Ex.9", "sections": [{"title": "分詞構文", "items": [{"ja": "私は学校へ歩いた＋歌を歌いながら。", "en": "I walked to school singing a song."}, {"ja": "彼女は本を読んでいた＋ベンチに座って。", "en": "She was sitting on the bench reading a book."}, {"ja": "私は自分の夢について考えた＋星を見ながら。", "en": "I thought about my dreams looking at the stars."}, {"ja": "彼女は朝食を食べた＋ニュースを見ながら。", "en": "She ate breakfast watching the news."}, {"ja": "私たちは話した＋空を見ながら。", "en": "We talked looking at the sky."}, {"ja": "私はバスを待った＋花を持って。", "en": "I waited for the bus holding some flowers."}, {"ja": "赤ちゃんは泣いた＋おもちゃを握りながら。", "en": "The baby cried holding his toy."}, {"ja": "私は部屋を掃除した＋お気に入りの歌を歌いながら。", "en": "I cleaned my room singing my favorite song."}, {"ja": "私たちは家へ歩いた＋その日のことを話しながら。", "en": "We walked home talking about the day."}, {"ja": "私はテレビを見た＋ポップコーンを食べながら。", "en": "I watched TV eating popcorn."}, {"ja": "彼女は絵を描いた＋ラジオを聴きながら。", "en": "She drew a picture listening to the radio."}, {"ja": "彼は本を読んでいた＋ベッドに横になって。", "en": "He was reading a book lying on the bed."}, {"ja": "彼は電車を待った＋スマホを見ながら。", "en": "He waited for the train looking at his phone."}, {"ja": "私は英語を勉強していた＋辞書を使って。", "en": "I was studying English using my dictionary."}, {"ja": "彼女はキッチンで働いた＋昼食を作りながら。", "en": "She worked in the kitchen preparing lunch."}, {"ja": "彼は自転車を修理した＋道具を使って。", "en": "He fixed his bike using his tools."}, {"ja": "彼女は踊った＋お気に入りの歌を聴きながら。", "en": "She danced listening to her favorite song."}, {"ja": "小さな男の子は母親のもとへ走った＋泣きながら。", "en": "The little boy ran to his mother crying."}, {"ja": "私たちは昼食を食べた＋木の下に座って。", "en": "We ate lunch sitting under a tree."}, {"ja": "その男はゆっくり歩いた＋過去を思い出しながら。", "en": "The man walked slowly thinking about his past."}, {"ja": "私たちは川沿いを歩いた＋石を集めながら。", "en": "We walked along the river collecting stones."}, {"ja": "彼女は微笑んだ＋幸せな瞬間を思い出しながら。", "en": "She smiled remembering a happy moment."}, {"ja": "私は駅で待った＋切符を持ちながら。", "en": "I waited at the station holding my ticket."}, {"ja": "私は犬と遊んだ＋床に座って。", "en": "I sat on the floor playing with my dog."}, {"ja": "この家は素敵だ＋緑色に塗られていて。", "en": "This house looks nice painted green."}, {"ja": "ネズミは速く走った＋猫に追いかけられて。", "en": "The mouse ran fast chased by a cat."}, {"ja": "私は寝た＋疲れて。", "en": "I went to bed tired."}, {"ja": "彼は歌を歌っていた＋酔って。", "en": "He was singing a song drunk."}, {"ja": "私は彼と話した＋とても興奮して。", "en": "I talked with him very excited."}, {"ja": "彼女はベッドに横になった＋疲れ果てて。", "en": "She lay on the bed exhausted."}, {"ja": "彼は試合に出られなかった＋怪我で。", "en": "He couldn't play the game injured."}, {"ja": "彼は立っていた＋腕を組んで。", "en": "He stood with his arms crossed."}]}], "total": 32}, {"id": "Ex.10", "sections": [{"title": "名詞節（what）", "items": [{"ja": "彼がしていること・彼が何をしているか", "en": "what he is doing"}, {"ja": "彼女が言ったこと・彼女が何を言ったか", "en": "what she said"}, {"ja": "私が買うべきもの・私が何を買うべきか", "en": "what I should buy"}, {"ja": "彼が持っている物・彼が何を持っているか", "en": "what he has"}, {"ja": "彼女がしたいこと・彼女が何をしたいか", "en": "what she wants to do"}, {"ja": "彼が考えている事・彼が何を考えているか", "en": "what he is thinking"}, {"ja": "彼女が見ている物・彼女が何を見ているか", "en": "what she is looking at"}, {"ja": "あなたが学んだ事・あなたが何を学んだか", "en": "what you learned"}, {"ja": "私たちが決める事・私たちが何を決めるか", "en": "what we decide"}, {"ja": "彼が言いたかった事・彼が何を言いたかったか", "en": "what he wanted to say"}, {"ja": "すべきこと・何をするべきか", "en": "what to do"}, {"ja": "何が問題なのか", "en": "what the problem is"}, {"ja": "それが何であるか", "en": "what it is"}, {"ja": "彼が何時に家に戻るか", "en": "what time he will come home"}]}, {"title": "名詞節（where）", "items": [{"ja": "彼がどこに行ったか", "en": "where he went"}, {"ja": "私たちがどこで会うか", "en": "where we will meet"}, {"ja": "彼女がどこに住んでいるか", "en": "where she lives"}, {"ja": "彼らがどこで働いているか", "en": "where they work"}, {"ja": "あなたがどこに行くか", "en": "where you go"}, {"ja": "その店がどこにあるか", "en": "where the store is"}, {"ja": "彼がどこにいたか", "en": "where he was"}, {"ja": "私がどこに座るべきか", "en": "where I should sit"}, {"ja": "彼女がどこに行ったか", "en": "where she went"}, {"ja": "私たちがどこで食事するか", "en": "where we will have dinner"}, {"ja": "彼がどこに泊まるか", "en": "where he will stay"}, {"ja": "どこに行くべきか", "en": "where to go"}, {"ja": "あなたがどこで買ったか", "en": "where you bought it"}, {"ja": "そのイベントがどこで開催されるか", "en": "where the event will take place"}, {"ja": "私がどこで英語を学んでいるか", "en": "where I learn English"}]}, {"title": "名詞節（when）", "items": [{"ja": "会議がいつ始まるか", "en": "when the meeting starts"}, {"ja": "彼がいつ戻るか", "en": "when he returns"}, {"ja": "電車がいつ出発するか", "en": "when the train leaves"}, {"ja": "あなたがいつ来るか", "en": "when you are coming"}, {"ja": "授業がいつ終わるか", "en": "when the class finishes"}, {"ja": "彼がいつ仕事を終えるか", "en": "when he finishes work"}, {"ja": "映画がいつ始まるか", "en": "when the movie starts"}, {"ja": "彼がいつ到着するか", "en": "when he arrives"}, {"ja": "いつ出発すべきか", "en": "when to leave"}, {"ja": "彼がいつ会議に出席するか", "en": "when he attends the meeting"}, {"ja": "その試合がいつ行われるか", "en": "when the game takes place"}]}, {"title": "名詞節（why）", "items": [{"ja": "彼がなぜ怒っているか", "en": "why he is angry"}, {"ja": "彼女がなぜ泣いているか", "en": "why she is crying"}, {"ja": "あなたがなぜ遅れたか", "en": "why you were late"}, {"ja": "その決定がなぜ下されたか", "en": "why the decision was made"}, {"ja": "彼がなぜそれを言ったか", "en": "why he said that"}, {"ja": "何が原因で遅れたか", "en": "why the delay occurred"}, {"ja": "彼女がなぜその仕事を辞めたか", "en": "why she quit the job"}, {"ja": "私たちがなぜこの選択をしたか", "en": "why we made this choice"}, {"ja": "彼がなぜ一生懸命働くか", "en": "why he works hard"}, {"ja": "あなたがなぜそれをしているか", "en": "why you are doing that"}]}, {"title": "名詞節（who）", "items": [{"ja": "彼が誰と話しているか", "en": "who he is talking to"}, {"ja": "彼女が誰を選ぶか", "en": "who she will choose"}, {"ja": "彼らが誰を招待するか", "en": "who they will invite"}, {"ja": "私たちが誰を助けるべきか", "en": "who we should help"}, {"ja": "誰がそれをしたか", "en": "who did it"}, {"ja": "あなたが誰と一緒に行くか", "en": "who you are going with"}, {"ja": "彼女が誰を待っているか", "en": "who she is waiting for"}, {"ja": "彼が誰にそのことを話したか", "en": "who he told that to"}, {"ja": "彼が誰と結婚したか", "en": "who he married"}, {"ja": "彼女が誰を尊敬しているか", "en": "who she respects"}, {"ja": "誰がこれを買ったか", "en": "who bought it"}, {"ja": "誰に会うべきか", "en": "who to see"}]}, {"title": "名詞節（how）", "items": [{"ja": "彼がどのようにそれをしたか", "en": "how he did it"}, {"ja": "それがどのように動くか", "en": "how it works"}, {"ja": "彼女がどのように感じているか", "en": "how she feels"}, {"ja": "それをどのように使うか", "en": "how to use it"}, {"ja": "彼がどのように勉強しているか", "en": "how he is studying"}, {"ja": "彼女がどのように料理するか", "en": "how she cooks"}, {"ja": "あなたがどのようにそれを解決したか", "en": "how you solved it"}, {"ja": "その問題がどのように解決されたか", "en": "how the problem was solved"}, {"ja": "彼がどのように質問を答えたか", "en": "how he answered the question"}, {"ja": "彼女がどのように目標を達成したか", "en": "how she achieved her goal"}, {"ja": "あなたがどう生きるか", "en": "how you live"}, {"ja": "弁護士がそれをどう説明するか", "en": "how the lawyer will explain it"}]}, {"title": "名詞節（which）", "items": [{"ja": "彼がどちらを選んだか", "en": "which one he chose"}, {"ja": "あなたがどちらと一緒に行くつもりか", "en": "which one you are going with"}, {"ja": "私たちがどちらに行くべきか", "en": "which one we should go to"}, {"ja": "彼がどちらの服を着るつもりか", "en": "which clothes he will wear"}, {"ja": "あなたがどちらを持っているか", "en": "which one you have"}, {"ja": "彼がどちらの本を読むつもりか", "en": "which book he is going to read"}, {"ja": "彼女がどちらを選んだか", "en": "which one she picked"}, {"ja": "どちらが正しいか", "en": "which one is correct"}, {"ja": "彼がどの車を売るか", "en": "which car he will sell"}, {"ja": "あなたがどちらを買うべきか", "en": "which one you should buy"}, {"ja": "どの会社に頼めばいいか", "en": "which company to ask"}]}, {"title": "名詞節（whose）", "items": [{"ja": "彼が誰のバッグを持っているか", "en": "whose bag he is holding"}, {"ja": "それが誰のペンか", "en": "whose pen that is"}, {"ja": "彼女が誰の家に行くか", "en": "whose house she is going to"}, {"ja": "これが誰の財布か", "en": "whose wallet this is"}, {"ja": "彼が誰の本を持っているか", "en": "whose book he is holding"}, {"ja": "それが誰の車か", "en": "whose car it is"}, {"ja": "彼女が誰のチケットを持っているか", "en": "whose ticket she has"}, {"ja": "これが誰のプレゼントか", "en": "whose present this is"}, {"ja": "それが誰の責任か", "en": "whose responsibility it is"}, {"ja": "彼女が誰の写真を見せているか", "en": "whose photo she is showing"}]}, {"title": "名詞節（whether）", "items": [{"ja": "彼が来るかどうか", "en": "whether he will come"}, {"ja": "それが本当かどうか", "en": "whether it is true"}, {"ja": "私たちがそのイベントに参加するかどうか", "en": "whether we will attend the event"}, {"ja": "彼女がそれを理解しているかどうか", "en": "whether she understands it"}, {"ja": "彼が遅れるかどうか", "en": "whether he will be late"}, {"ja": "あなたがそれをするかどうか", "en": "whether you will do it"}, {"ja": "それが可能かどうか", "en": "whether it is possible"}, {"ja": "彼がそれに同意するかどうか", "en": "whether he agrees with it"}, {"ja": "あなたがそれを買うかどうか", "en": "whether you will buy it"}, {"ja": "彼女が参加するかどうか", "en": "whether she will participate"}]}, {"title": "名詞節（how+形容詞・副詞）", "items": [{"ja": "彼女が何歳であるか", "en": "how old she is"}, {"ja": "あなたがどれくらいの身長か", "en": "how tall you are"}, {"ja": "それがどれくらい重いか", "en": "how heavy it is"}, {"ja": "彼らがどれくらい疲れているか", "en": "how tired they are"}, {"ja": "私がどれくらい眠いか", "en": "how sleepy I am"}, {"ja": "その男の子がどれだけワクワクしているか", "en": "how excited the boy is"}, {"ja": "彼がどれくらい悲しんだか", "en": "how sad he was"}, {"ja": "その女の子がどれくらい嬉しかったか", "en": "how happy she was"}, {"ja": "その犬がどれくらい大きくなるか", "en": "how big the dog will be"}, {"ja": "私がどれくらい空腹か", "en": "how hungry I am"}, {"ja": "彼女がどれくらい怒るか", "en": "how angry she gets"}, {"ja": "その車がどれくらい速く走るか", "en": "how fast the car runs"}, {"ja": "そのPCがどれくらい速く動くか", "en": "how fast the PC works"}, {"ja": "その男の子がどれくらい賢いか", "en": "how smart the boy is"}, {"ja": "私の同僚がどれだけ優秀か", "en": "how good my coworker is"}, {"ja": "彼女がどれだけ努力したか", "en": "how much effort she made"}, {"ja": "あなたがどれだけ準備したか", "en": "how much you prepared"}, {"ja": "彼がどれくらいの時間かかったか", "en": "how long it took him"}, {"ja": "彼女がどれだけ素晴らしいか", "en": "how wonderful she is"}, {"ja": "その会議がどれだけ長かったか", "en": "how long the meeting was"}, {"ja": "彼がそれをどれだけ好きか", "en": "how much he likes it"}, {"ja": "彼女がどれくらい速くそれをやったか", "en": "how fast she did it"}, {"ja": "それがどれだけ重要か", "en": "how important it is"}, {"ja": "彼女がどれくらい上手にそれを説明するか", "en": "how well she explains it"}, {"ja": "彼がどれだけ人気があったか", "en": "how popular he was"}]}], "total": 130}, {"id": "Ex.11", "sections": [{"title": "前置詞（at）", "items": [{"ja": "駅にいる人々", "en": "the people at the station"}, {"ja": "公園の子供たち", "en": "the children at the park"}, {"ja": "その店の男性", "en": "the man at the shop"}, {"ja": "バス停の女性", "en": "the woman at the bus stop"}, {"ja": "見て＋私を。", "en": "Look at me."}, {"ja": "それは始まる＋夜に。", "en": "It starts at night."}, {"ja": "彼は勉強した＋学校で。", "en": "He studied at school."}, {"ja": "彼らは待っていた＋駅で。", "en": "They waited at the station."}, {"ja": "彼女は立っている＋ドアのところに。", "en": "She is standing at the door."}]}, {"title": "前置詞（in）", "items": [{"ja": "部屋の中の本", "en": "the book in the room"}, {"ja": "公園にいる少年", "en": "the boy in the park"}, {"ja": "山の中の湖", "en": "the lake in the mountains"}, {"ja": "カバンの中のリンゴ", "en": "the apple in the bag"}, {"ja": "本の中の絵", "en": "the picture in the book"}, {"ja": "彼はいる＋部屋に。", "en": "He is in the room."}, {"ja": "彼らは遊んでいる＋公園で。", "en": "They are playing in the park."}, {"ja": "寒くなる＋冬は。", "en": "It gets cold in winter."}, {"ja": "何かがある＋箱の中に。", "en": "There is something in the box."}]}, {"title": "前置詞（to）", "items": [{"ja": "駅への道", "en": "the road to the station"}, {"ja": "学校への手紙", "en": "the letter to the school"}, {"ja": "東京行きのバス", "en": "the bus to Tokyo"}, {"ja": "友達への贈り物", "en": "the gift to my friend"}, {"ja": "そのドアの鍵", "en": "the key to the door"}, {"ja": "彼女は向かっている＋学校に。", "en": "She is going to school."}, {"ja": "彼らは走った＋駅まで。", "en": "They ran to the station."}, {"ja": "彼は行った＋バス停に。", "en": "He went to the bus stop."}, {"ja": "私たちは旅行に行った＋ヨーロッパへ。", "en": "We traveled to Europe."}]}, {"title": "前置詞（for）", "items": [{"ja": "子どもたちのための本", "en": "the book for children"}, {"ja": "彼女への手紙", "en": "the letter for her"}, {"ja": "学生向けのクラス", "en": "the class for students"}, {"ja": "犬の食べ物", "en": "the food for dogs"}, {"ja": "彼女は準備をした＋学校の。", "en": "She prepared for school."}, {"ja": "彼は働いた＋家族のために。", "en": "He worked for his family."}, {"ja": "彼らは勉強した＋テストのために。", "en": "They studied for the test."}, {"ja": "私たちは話し合った＋会議のために。", "en": "We discussed for the meeting."}]}, {"title": "前置詞（on）", "items": [{"ja": "テーブルの上の皿", "en": "the plate on the table"}, {"ja": "壁にかかっている絵", "en": "the picture on the wall"}, {"ja": "自転車に乗った少年", "en": "the boy on the bicycle"}, {"ja": "山の上の家", "en": "the house on the mountain"}, {"ja": "私は写真をかけた＋壁に。", "en": "I hung the photo on the wall."}, {"ja": "彼は乗っている＋自転車に。", "en": "He is on the bicycle."}, {"ja": "彼女は乗った＋電車に。", "en": "She got on the train."}, {"ja": "彼らはそれを見た＋テレビで。", "en": "They saw it on TV."}]}, {"title": "前置詞（of）", "items": [{"ja": "植物の葉っぱ", "en": "the leaves of the plant"}, {"ja": "家のドア", "en": "the door of the house"}, {"ja": "川の名前", "en": "the name of the river"}, {"ja": "クラスのメンバー", "en": "the members of the class"}, {"ja": "彼は聞いた＋それについて。", "en": "He heard of it."}, {"ja": "私は知っている＋そのニュースについて。", "en": "I know of the news."}, {"ja": "彼らは考えた＋それについて。", "en": "They thought of it."}]}, {"title": "前置詞（off）", "items": [{"ja": "テーブルから落ちたボール", "en": "the ball off the table"}, {"ja": "バスを降りる男の人", "en": "the man off the bus"}, {"ja": "船を降りた乗客", "en": "the passenger off the ship"}, {"ja": "木から取られたリンゴ", "en": "the apple off the tree"}, {"ja": "猫が飛び降りた＋テーブルから。", "en": "The cat jumped off the table."}, {"ja": "彼女は脱いだ＋帽子を。", "en": "She took off her hat."}, {"ja": "消してください＋電気を。", "en": "Please turn off the light."}, {"ja": "彼らは降りている＋飛行機から。", "en": "They are getting off the plane."}]}, {"title": "前置詞（from）", "items": [{"ja": "カナダ出身の男の人", "en": "the man from Canada"}, {"ja": "空港からのバス", "en": "the bus from the airport"}, {"ja": "ラジオから流れる音楽", "en": "the music from the radio"}, {"ja": "家から持ってきた本", "en": "the book from home"}, {"ja": "彼は帰ってきた＋学校から。", "en": "He came back from school."}, {"ja": "私は手紙をもらった＋友達から。", "en": "I got a letter from my friend."}, {"ja": "その音楽は流れている＋ラジオから。", "en": "The music is coming from the radio."}, {"ja": "彼らは出発した＋空港から。", "en": "They departed from the airport."}]}, {"title": "前置詞（by）", "items": [{"ja": "川のそばの家", "en": "the house by the river"}, {"ja": "バス停の近くの店", "en": "the shop by the bus stop"}, {"ja": "窓の近くの椅子", "en": "the chair by the window"}, {"ja": "橋の隣の建物", "en": "the building by the bridge"}, {"ja": "彼は来た＋車で。", "en": "He came by car."}, {"ja": "本は書かれた＋彼女によって。", "en": "The book was written by her."}, {"ja": "私たちは歩いた＋海の近くを。", "en": "We walked by the sea."}, {"ja": "彼らは通り過ぎた＋店のそばを。", "en": "They went by the shop."}]}, {"title": "前置詞（with）", "items": [{"ja": "カメラを持った少年", "en": "the boy with a camera"}, {"ja": "青い目をした女の子", "en": "the girl with blue eyes"}, {"ja": "大きなバッグを持った男の人", "en": "the man with a big bag"}, {"ja": "かわいい犬を連れた女性", "en": "the woman with a cute dog"}, {"ja": "彼は話した＋笑顔で。", "en": "He spoke with a smile."}, {"ja": "彼女は手紙を書いた＋ペンで。", "en": "She wrote a letter with a pen."}, {"ja": "私たちは踊った＋音楽と一緒に。", "en": "We danced with the music."}, {"ja": "彼は公園に行った＋友達と一緒に。", "en": "He went to the park with his friends."}]}, {"title": "前置詞（about）", "items": [{"ja": "音楽についての本", "en": "the book about music"}, {"ja": "彼についての話", "en": "the story about him"}, {"ja": "自然に関する映画", "en": "the movie about nature"}, {"ja": "テストに関する質問", "en": "the question about the test"}, {"ja": "彼は知らない＋その問題について。", "en": "He doesn't know about the problem."}, {"ja": "その本は＋旅行に関するものだ。", "en": "The book is about travel."}, {"ja": "彼らは考えている＋将来について。", "en": "They are thinking about the future."}]}], "total": 89}];

// ===== STORAGE =====
var SK='pp_drill_v3';
function LS(){try{return JSON.parse(localStorage.getItem(SK))||{}}catch(e){return{}}}
function SS(s){try{localStorage.setItem(SK,JSON.stringify(s))}catch(e){}}
function GE(id){var s=LS();return s[id]||{h:{},li:0}}
function SE(id,d){var s=LS();s[id]=d;SS(s)}
function RE(id){var s=LS();delete s[id];SS(s)}

// ===== STATE =====
var shuffle=false,curExIdx=-1,curEx=null;
var items=[],idx=0,revealed=false,cOk=0,cNg=0;
var qStatus=[],sessionWrong=[];
var pendingSecSel=null;
var autoMode=false,autoFrontSec=3,autoBackSec=3,autoTimerId=null,autoCountdownId=null,autoPaused=false;

// ===== SPEECH =====
var cEn=null,cJa=null;
function getV(lang){
  var vs=speechSynthesis.getVoices();if(!vs.length)return null;
  if(lang==='en'){
    if(cEn)return cEn;
    var ps=[function(v){return v.lang==='en-US'&&/Google US/i.test(v.name)},function(v){return v.lang==='en-US'&&/Samantha/i.test(v.name)},function(v){return v.lang==='en-US'},function(v){return v.lang.indexOf('en')===0}];
    for(var i=0;i<ps.length;i++){var f=vs.find(ps[i]);if(f){cEn=f;return f}}
  }else{
    if(cJa)return cJa;
    var ps=[function(v){return v.lang==='ja-JP'&&/Google/i.test(v.name)},function(v){return v.lang==='ja-JP'},function(v){return v.lang.indexOf('ja')===0}];
    for(var i=0;i<ps.length;i++){var f=vs.find(ps[i]);if(f){cJa=f;return f}}
  }
  return null;
}
function speak(t,l){if(!('speechSynthesis' in window))return;speechSynthesis.cancel();var u=new SpeechSynthesisUtterance(t);u.lang=l==='en'?'en-US':'ja-JP';u.rate=l==='en'?0.9:1.05;u.pitch=l==='en'?1.0:0.85;var v=getV(l);if(v)u.voice=v;speechSynthesis.speak(u)}
function speakJa(){speak(items[idx].ja,'ja')}
function speakEn(){speak(items[idx].en,'en')}
if('speechSynthesis' in window){speechSynthesis.onvoiceschanged=function(){cEn=null;cJa=null};setTimeout(function(){speechSynthesis.getVoices()},100)}

// ===== MENU =====
function buildMenu(){
  var g=$('menu-grid'),h='',total=0;
  for(var i=0;i<DB.length;i++){
    var ex=DB[i],st=GE(ex.id),hist=st.h||{};
    var okC=0,ngC=0;
    for(var k in hist){if(hist[k]==='ok')okC++;else ngC++}
    var done=okC+ngC,pct=ex.total>0?Math.round(done/ex.total*100):0;
    var secN='';
    if(ex.sections.length>1){
      var titles=ex.sections.map(function(s){return s.title});
      var m=titles[0].match(/^(.+?)（/);
      if(m&&titles.every(function(t){return t.indexOf(m[1]+'（')===0})){
        secN=titles.map(function(t){var p=t.match(/（(.+?)）/);return p?p[1]:t}).join(' / ');
      }else{secN=titles.join(', ');}
    }
    var tName=ex.sections.length===1?ex.sections[0].title:ex.sections[0].title.split('（')[0];
    h+='<div class="menu-card" onclick="selectEx('+i+')">';
    h+='<div class="mc-top"><span class="mc-num mono">'+ex.id+'</span><span class="mc-title">'+tName+'</span><span class="mc-count mono">'+ex.total+'問</span></div>';
    h+='<div class="mc-progress"><div class="mc-progress-fill" style="width:'+pct+'%"></div></div>';
    h+='<div class="mc-stats">';
    if(done>0){h+='<span>進捗 '+pct+'%</span><span class="mc-stat-ok">◯'+okC+'</span><span class="mc-stat-ng">✕'+ngC+'</span>'}
    else{h+='<span>未学習</span>'}
    h+='</div>';
    if(secN)h+='<div class="mc-sections">'+secN+'</div>';
    h+='</div>';
    total+=ex.total;
  }
  g.innerHTML=h;
  $('menu-sub').textContent=DB.length+' Exercises \u00B7 '+total+' Items';
}
function toggleShuffle(){shuffle=!shuffle;$('sw-shuffle').className=shuffle?'sw on':'sw'}
function toggleAutoMode(){autoMode=!autoMode;$('sw-auto').className=autoMode?'sw on':'sw';$('auto-settings').classList.toggle('visible',autoMode)}
function adjTime(side,d){if(side==='front'){autoFrontSec=Math.max(1,Math.min(15,autoFrontSec+d));$('auto-front-sec').textContent=autoFrontSec}else{autoBackSec=Math.max(1,Math.min(15,autoBackSec+d));$('auto-back-sec').textContent=autoBackSec}}

function selectEx(i){curExIdx=i;curEx=DB[i];if(curEx.sections.length>1)openSec();else openMode(null)}

// ===== SECTION SELECT =====
var secSel=[];
function openSec(){
  secSel=[];for(var i=0;i<curEx.sections.length;i++)secSel.push(true);
  $('sec-title').textContent=curEx.id;
  $('sec-sub').textContent='セクションを選択';
  renderSecList();$('ov-sec').classList.add('visible');
}
function closeSec(){$('ov-sec').classList.remove('visible')}
function renderSecList(){
  var l=$('sec-list'),h='';
  for(var i=0;i<curEx.sections.length;i++){
    var s=curEx.sections[i],sel=secSel[i];
    h+='<div class="sec-item'+(sel?' selected':'')+'" onclick="toggleSecItem('+i+')"><div class="sec-cb"></div><span class="sec-name">'+s.title+'</span><span class="sec-cnt mono">'+s.items.length+'</span></div>';
  }
  l.innerHTML=h;$('sec-ok').disabled=!secSel.some(function(v){return v});
}
function toggleSecItem(i){secSel[i]=!secSel[i];renderSecList()}
function toggleAllSec(){var all=secSel.every(function(v){return v});for(var i=0;i<secSel.length;i++)secSel[i]=!all;renderSecList()}
function confirmSec(){closeSec();openMode(secSel)}

// ===== MODE SELECT =====
function openMode(secSelArr){
  pendingSecSel=secSelArr;
  var st=GE(curEx.id),hist=st.h||{},li=st.li||0;
  var okC=0,ngC=0;
  for(var k in hist){if(hist[k]==='ok')okC++;else ngC++}
  var done=okC+ngC;
  var tName=curEx.sections.length===1?curEx.sections[0].title:curEx.sections[0].title.split('（')[0];
  $('mode-title').textContent=curEx.id+' '+tName;
  var b='';
  b+='<button class="mode-btn start" onclick="startMode(\'start\')"><span class="icon">▶</span><div class="info"><div>最初から</div><div class="info-sub">全問チャレンジ</div></div></button>';
  if(autoMode){b+='<button class="mode-btn start" onclick="startMode(\'auto\')" style="background:rgba(242,204,143,0.15);color:#F2CC8F;border-color:rgba(242,204,143,0.3)"><span class="icon">▶</span><div class="info"><div>Auto Play</div><div class="info-sub">自動再生（'+autoFrontSec+'秒/'+autoBackSec+'秒）</div></div></button>';}
  b+='<button class="mode-btn resume" onclick="startMode(\'resume\')"'+(done===0?' disabled':'')+' ><span class="icon">↻</span><div class="info"><div>続きから</div><div class="info-sub">'+(done>0?'問'+(li+1)+'から再開（'+done+'/'+curEx.total+'済）':'データなし')+'</div></div></button>';
  b+='<button class="mode-btn retry" onclick="startMode(\'retry\')"'+(ngC===0?' disabled':'')+' ><span class="icon">❌</span><div class="info"><div>❌だけ復習</div><div class="info-sub">'+(ngC>0?ngC+'問':'間違いなし')+'</div></div></button>';
  b+='<button class="mode-btn reset" onclick="confirmReset()"><span class="icon">🗑</span><div class="info"><div>履歴リセット</div></div></button>';
  b+='<button class="mode-btn mcancel" onclick="closeMode()"><span class="icon">←</span><div class="info"><div>戻る</div></div></button>';
  $('mode-body').innerHTML=b;$('ov-mode').classList.add('visible');
}
function closeMode(){$('ov-mode').classList.remove('visible')}

// ===== CONFIRM RESET =====
function confirmReset(){
  $('confirm-text').textContent=curEx.id+' の学習履歴をリセットしますか？';
  $('confirm-yes').onclick=function(){RE(curEx.id);closeConfirm();closeMode();buildMenu()};
  $('ov-confirm').classList.add('visible');
}
function closeConfirm(){$('ov-confirm').classList.remove('visible')}

// ===== START PRACTICE =====
function startMode(mode){
  closeMode();stopAuto();
  var isAuto=(mode==='auto');
  items=[];
  var secs=curEx.sections;
  for(var si=0;si<secs.length;si++){
    if(pendingSecSel && !pendingSecSel[si])continue;
    for(var ii=0;ii<secs[si].items.length;ii++){
      items.push({ja:secs[si].items[ii].ja, en:secs[si].items[ii].en, sec:secs[si].title, key:si+'-'+ii});
    }
  }

  var st=GE(curEx.id),hist=st.h||{};

  if(mode==='retry'){
    items=items.filter(function(it){return hist[it.key]==='ng'});
  }

  if(shuffle){for(var i=items.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=items[i];items[i]=items[j];items[j]=t}}

  if(mode==='resume'){
    var li=st.li||0;
    var found=-1;
    for(var i=li;i<items.length;i++){if(!hist[items[i].key]){found=i;break}}
    if(found===-1){for(var i=0;i<li;i++){if(!hist[items[i].key]){found=i;break}}}
    idx=found>=0?found:0;
  }else{
    idx=0;
  }

  cOk=0;cNg=0;sessionWrong=[];
  qStatus=[];
  for(var i=0;i<items.length;i++){
    var h=hist[items[i].key];
    if(h==='ok')qStatus.push('done');
    else if(h==='ng')qStatus.push('has-wrong');
    else qStatus.push('pending');
  }

  var tName=curEx.sections.length===1?curEx.sections[0].title:curEx.sections[0].title.split('（')[0];
  $('hdr-title').innerHTML='<b>'+curEx.id+'</b> '+(isAuto?'▶ Auto Play':tName);
  $('auto-bar').classList.toggle('visible',isAuto);
  $('manual-controls').style.display=isAuto?'none':'';
  autoPaused=false;
  if(isAuto){$('pause-icon').style.display='';$('play-icon').style.display='none';$('pause-label').textContent='一時停止';$('auto-status').textContent='Auto Play 再生中...';}
  showScreen('scr-practice');showCard();
  if(isAuto)startAutoStep();
}

// ===== PRACTICE UI =====
function $(id){return document.getElementById(id)}
function showScreen(id){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});$(id).classList.add('active')}

function showCard(dir){
  var p=items[idx],n=items.length;
  $('counter').textContent=(idx+1)+'/'+n;
  $('progress-fill').style.width=((idx+1)/n*100)+'%';
  var badge=$('section-badge');
  badge.textContent=curEx.sections.length>1?p.sec:'';
  var qt=$('q-text');qt.textContent=p.ja;qt.className='q-text'+(p.ja.length>20?' small':'');
  var at=$('a-text');at.textContent=p.en;at.className='a-text'+(p.en.length>40?' small':'');
  var as=$('a-section');as.classList.remove('revealed');as.classList.add('hidden-answer');
  revealed=false;
  var hm=$('q-hist'),st=GE(curEx.id),hist=st.h||{},prev=hist[p.key];
  if(prev==='ok'){hm.className='history-mark ok';hm.textContent='前回◯'}
  else if(prev==='ng'){hm.className='history-mark ng';hm.textContent='前回✕'}
  else{hm.className='history-mark';hm.textContent=''}
  $('btn-prev').disabled=(idx===0);
  $('btn-next').disabled=(idx>=n-1);
  $('btn-wrong').disabled=true;
  $('btn-ok').disabled=true;
  $('s-ok').textContent=cOk;
  $('s-ng').textContent=cNg;
  var card=$('card');card.classList.remove('anim-next','anim-prev');
  void card.offsetWidth;
  if(dir==='next')card.classList.add('anim-next');
  else if(dir==='prev')card.classList.add('anim-prev');
}

function revealAnswer(){
  if(revealed)return;revealed=true;
  var as=$('a-section');as.classList.remove('hidden-answer');as.classList.add('revealed');
  $('btn-wrong').disabled=false;$('btn-ok').disabled=false;
  speak(items[idx].en,'en');
}

function judge(ok){
  if(!revealed)return;
  var key=items[idx].key;
  if(ok){cOk++;qStatus[idx]='done'}else{cNg++;qStatus[idx]='has-wrong';sessionWrong.push(items[idx])}
  var st=GE(curEx.id);if(!st.h)st.h={};
  st.h[key]=ok?'ok':'ng';st.li=idx;SE(curEx.id,st);
  if(idx+1>=items.length){showResult();return}
  idx++;showCard('next');
}

function goPrev(){if(idx>0){idx--;showCard('prev')}}
function goNext(){if(idx+1<items.length){idx++;showCard('next')}}

function backToMenu(){
  speechSynthesis.cancel();
  $('ov-result').classList.remove('visible');
  buildMenu();showScreen('scr-menu');
}

// ===== JUMP =====
function openJump(){
  var g=$('jump-grid'),h='';
  for(var i=0;i<items.length;i++){
    var c='jump-cell';if(i===idx)c+=' active';else if(qStatus[i]==='done')c+=' done';else if(qStatus[i]==='has-wrong')c+=' has-wrong';
    h+='<button class="'+c+'" onclick="jumpTo('+i+')">'+(i+1)+'</button>';
  }
  g.innerHTML=h;$('ov-jump').classList.add('visible');
}
function closeJump(){$('ov-jump').classList.remove('visible')}
function jumpTo(i){closeJump();if(i===idx)return;var d=i>idx?'next':'prev';idx=i;showCard(d)}

// ===== RESULT =====
function showResult(){
  var t=cOk+cNg,pct=t>0?Math.round(cOk/t*100):0;
  $('r-pct').textContent=pct+'%';
  $('r-sub').textContent=cOk+' / '+t+' correct';
  $('r-ok').textContent=cOk;$('r-ng').textContent=cNg;
  $('r-retry-n').textContent=sessionWrong.length;
  $('r-retry').style.display=sessionWrong.length>0?'block':'none';
  $('ov-result').classList.add('visible');
}
function restartFromResult(){
  $('ov-result').classList.remove('visible');
  idx=0;cOk=0;cNg=0;sessionWrong=[];
  qStatus=[];for(var i=0;i<items.length;i++)qStatus.push('pending');
  showCard();
}
function retryWrongFromResult(){
  $('ov-result').classList.remove('visible');
  items=sessionWrong.slice();
  idx=0;cOk=0;cNg=0;sessionWrong=[];
  qStatus=[];for(var i=0;i<items.length;i++)qStatus.push('pending');
  if(shuffle){for(var i=items.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=items[i];items[i]=items[j];items[j]=t}}
  showCard();
}

// ===== AUTO PLAY =====
function startAutoStep(){
  stopAutoTimers();
  if(autoPaused)return;
  speak(items[idx].ja,'ja');
  var sec=autoFrontSec;
  updateRing(sec,sec);
  $('timer-text').textContent=sec;
  autoCountdownId=setInterval(function(){
    sec--;
    if(sec<=0){
      clearInterval(autoCountdownId);autoCountdownId=null;
      revealAnswer();
      var sec2=autoBackSec;
      updateRing(sec2,sec2);
      $('timer-text').textContent=sec2;
      autoCountdownId=setInterval(function(){
        sec2--;
        if(sec2<=0){
          clearInterval(autoCountdownId);autoCountdownId=null;
          autoAdvance();
        }else{
          updateRing(sec2,autoBackSec);
          $('timer-text').textContent=sec2;
        }
      },1000);
    }else{
      updateRing(sec,autoFrontSec);
      $('timer-text').textContent=sec;
    }
  },1000);
}
function updateRing(remain,total){
  var circ=106.81;
  var offset=circ*(1-remain/total);
  $('ring-fg').setAttribute('stroke-dashoffset',offset);
}
function autoAdvance(){
  if(idx+1>=items.length){
    cOk+=items.length;showResult();stopAuto();return;
  }
  idx++;showCard('next');startAutoStep();
}
function stopAutoTimers(){
  if(autoTimerId){clearTimeout(autoTimerId);autoTimerId=null;}
  if(autoCountdownId){clearInterval(autoCountdownId);autoCountdownId=null;}
}
function stopAuto(){
  stopAutoTimers();autoPaused=false;
  $('auto-bar').classList.remove('visible');
  $('manual-controls').style.display='';
}
function toggleAutoPause(){
  if(autoPaused){
    autoPaused=false;
    $('pause-icon').style.display='';$('play-icon').style.display='none';
    $('pause-label').textContent='一時停止';
    $('auto-status').textContent='Auto Play 再生中...';
    startAutoStep();
  }else{
    autoPaused=true;
    stopAutoTimers();speechSynthesis.cancel();
    $('pause-icon').style.display='none';$('play-icon').style.display='';
    $('pause-label').textContent='再開';
    $('auto-status').textContent='一時停止中';
  }
}

// ===== KEYS =====
document.addEventListener('keydown',function(e){
  if($('scr-practice').classList.contains('active')&&!$('ov-jump').classList.contains('visible')){
    if(e.key===' '||e.key==='Enter'){e.preventDefault();revealAnswer()}
    if(e.key==='ArrowRight'&&revealed)judge(true);
    if(e.key==='ArrowLeft'&&revealed)judge(false);
  }
});

// ===== INIT =====
buildMenu();
</script>
</body>
</html>